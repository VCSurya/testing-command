<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <script src="{{url_for('static',filename='tailwind.js')}}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #181c24;
            --secondary-bg: #222736;
            --accent-bg: #23293a;
            --sidebar-bg: #181c24;
            --sidebar-border: #23293a;
            --card-bg: #23293a;

            --table-bg: #1e2230;
            --table-header-bg: #23293a;
            --table-row-hover: #23293a;
            --text-main: #f2f2f2;
            --text-secondary: #b0b6c1;
            --primary: #4f8cff;
            --danger: #ff4f70;
            --success: #4fffb0;
            --border-radius: 0.75rem;
            --transition: 0.2s cubic-bezier(.4, 0, .2, 1);
        }

        html,
        body {
            background: var(--primary-bg) !important;
            color: var(--text-main);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
        }

        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            width: 240px;
            padding: 32px 0 0;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            box-shadow: 2px 0 16px 0 #0002;
            transition: background var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 32px);
            padding-top: 0;
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-content {
            margin-left: 240px;
            padding: 0px 16px 16px 16px;
            background: var(--primary-bg);
            min-height: 100vh;
            transition: margin-left var(--transition);
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .nav-link {
            color: var(--text-secondary) !important;
            padding: 0.7rem 1.2rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            display: flex;
            align-items: center;
            transition: background var(--transition), color var(--transition);
        }

        .nav-link:hover,
        .nav-link:focus {
            color: var(--text-main) !important;
            background: var(--accent-bg);
            text-decoration: none;
        }

        .nav-link.active {
            color: var(--primary) !important;
            background: var(--accent-bg);
        }

        .sidebar h4 {
            color: var(--primary);
            letter-spacing: 1px;
            font-weight: 700;
        }

        /* Responsive adjustments */
        @media (max-width: 991.98px) {
            .sidebar {
                display: none;
            }
        }

        @media (max-width: 767.98px) {
            .sidebar {
                display: none;
            }

            .main-content {
                margin-left: 0;
            }

        }

        @media (max-width: 575.98px) {
            .main-content h1 {
                font-size: 1.15rem;
            }

        }

        /* Custom Sidebar & Topbar Styles */
        .custom-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 220px;
            height: 100vh;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            box-shadow: 2px 0 16px 0 #0002;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 2200;
            /* Make sure sidebar overlays above topbar */
            transition: transform 0.25s;
        }

        @media (max-width: 991.98px) {
            .custom-sidebar {
                z-index: 2200;
            }

        }

        .custom-topbar {
            z-index: 2100;
        }

        .sidebar-title {
            color: var(--primary);
            font-weight: 700;
            font-size: 2rem;
            letter-spacing: 1px;
            padding: 1.1rem 0rem 1.1rem 0rem;
            margin-bottom: 0.2rem;
            text-align: center;
            background: none;
            border: none;
            width: 100%;
            border-bottom: 1px solid var(--sidebar-border);
        }

        @media (max-width: 991.98px) {
            .sidebar-title {
                padding: 1.1rem 1.2rem 1.1rem 1.2rem;
                font-size: 1.5rem;
            }
        }

        @media (max-width: 575.98px) {
            .sidebar-title {
                padding: 1.1rem 0.9rem 1.1rem 0.9rem;
                font-size: 1.5rem;
            }
        }

        .sidebar-menu {
            width: 100%;
            list-style: none;
            padding: 0.5rem 0 1.5rem 0;
            margin: 0;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            gap: 0.5rem;
            /* Scrollable content */
            overflow-y: auto;
            /* allows vertical scrolling */
            -webkit-overflow-scrolling: touch;
            /* smooth scrolling on iOS */

        }

        /* Hide scrollbar for Webkit browsers (Chrome, Safari) */
        .sidebar-menu::-webkit-scrollbar {
            width: 0px;
            background: transparent;
            /* optional: just to be safe */
        }

        /* Hide scrollbar for Firefox */
        .sidebar-menu {
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
            /* IE and Edge */
        }

        .sidebar-menu li {
            width: 100%;
            display: flex;
        }

        .sidebar-link {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.85rem;
            text-decoration: none;
            font-weight: 500;
            font-size: 1.07rem;
            padding: 0.85rem 1.6rem;
            border-radius: var(--border-radius);
            color: var(--text-secondary);
            background: none;
            transition: background var(--transition), color var(--transition), box-shadow var(--transition);
            box-sizing: border-box;
        }

        .sidebar-link i {
            font-size: 1.25rem;
            min-width: 1.5rem;
            text-align: center;
        }

        .sidebar-link span {
            flex: 1 1 auto;
            text-align: left;
        }

        .sidebar-link.active,
        .sidebar-link:hover,
        .sidebar-link:focus {
            color: var(--primary);
            background: var(--accent-bg);
            box-shadow: 0 2px 12px 0 #0001;
        }

        @media (max-width: 991.98px) {
            .custom-sidebar {
                width: 88vw;
                max-width: 320px;
                min-width: 180px;
                padding-top: 0;
            }

            .sidebar-menu {
                padding: 1.2rem 0 1.5rem 0;
                gap: 0.25rem;
            }

            .sidebar-link {
                font-size: 1.03rem;
                padding: 1rem 1.25rem;
                border-radius: 0.7rem;
            }

            .sidebar-link i {
                font-size: 1.15rem;
            }
        }

        @media (max-width: 575.98px) {
            .custom-sidebar {
                width: 100vw;
                min-width: 0;
                max-width: 100vw;
                padding-top: 0;
            }

            .sidebar-menu {
                padding: 0.7rem 0 1.2rem 0;
                gap: 0.15rem;
            }

            .sidebar-link {
                font-size: 0.99rem;
                padding: 0.9rem 0.9rem;
                border-radius: 0.7rem;
            }

            .sidebar-link i {
                font-size: 1.07rem;
            }
        }


        .sidebar-link {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            text-decoration: none;
            font-weight: 500;
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            transition: background var(--transition), color var(--transition);
        }

        .sidebar-link.active,
        .sidebar-link:hover,
        .sidebar-link:focus {
            color: var(--primary);
            background: var(--accent-bg);
        }

        .sidebar-toggle {
            display: none;
            flex-direction: column;
            gap: 0.25rem;
            margin: 1.5rem 0 0 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 2100;
        }

        .sidebar-toggle span {
            display: block;
            width: 28px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        .custom-topbar {
            display: none;
            align-items: center;
            justify-content: flex-start;
            background: var(--sidebar-bg);
            border-bottom: 1px solid var(--sidebar-border);
            height: 56px;
            /* padding: 0 1.2rem; */
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2100;
        }

        .topbar-title {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.15rem;
        }

        .topbar-menu-btn {
            background: none;
            border: none;
            display: flex;
            flex-direction: column;
            gap: 0.22rem;
            margin-right: 1.1rem;
            cursor: pointer;
        }

        .topbar-menu-btn span {
            display: block;
            width: 26px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Responsive Sidebar/Topbar */
        @media (max-width: 991.98px) {
            .custom-sidebar {
                transform: translateX(-100%);
                width: 220px;
                box-shadow: 2px 0 16px 0 #0002;
            }

            .custom-sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: flex;
            }

            .custom-topbar {
                display: flex;
            }

            .main-content {
                margin-left: 0;
                padding-top: 72px;
            }

            .h2,
            h2 {
                font-size: 18px;
            }

            #topheder {
                padding-left: 15px;
                padding-right: 20px;
            }


        }

        @media (min-width: 992px) {
            .custom-topbar {
                display: flex;
            }

            .custom-sidebar {
                transform: translateX(-100%);
                width: 270px;
            }

            .custom-sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding-top: 72px;
            }
        }

        /* Hide sidebar header on mobile */
        @media (max-width: 991.98px) {
            .sidebar-header {
                display: none;
            }
        }

        /* Hide sidebar on mobile unless active */
        body.sidebar-open .custom-sidebar {
            transform: translateX(0) !important;
        }

        body.sidebar-open .main-content {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4c51bf',
                        'dark-bg': '#1f2937',
                        'dark-card': '#374151',
                        'light-text': '#f3f4f6',
                        'accent-yellow': '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        /* Utility class to ensure items are always visible when displayed */
        .invoice-item {
            display: flex;
        }

        /* Custom styling to remove the default arrow on the select element for a cleaner look */
        .integrated-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%239CA3AF'%3E%3Cpath fill-rule='evenodd' d='M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }

        .invoice-list-wrapper {
            max-height: 400px;
            overflow-y: scroll;
            scrollbar-width: thin;
            /* Firefox */
            scrollbar-color: #373737 transparent;
        }

        /* Chrome, Edge, Safari */
        .invoice-list-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .invoice-list-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .invoice-list-wrapper::-webkit-scrollbar-thumb {
            background-color: #dfed68;
            border-radius: 10px;
        }
    </style>
    <style>
        /* USER CARD */
        .sidebar-user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
            width: 100%;
            justify-content: center;

        }


        .user-name {
            font-size: 1em;
            font-weight: 600;
            color: #fff;
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar-user-card {
                justify-content: center;
            }

            .user-details {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Custom Responsive Navigation -->
    <aside class="custom-sidebar" id="sidebar">
        <h1 class="sidebar-title">Manager<span style="color: rgb(250, 250, 121);">Pro</span></h1>
        <ul class="sidebar-menu">
            <li><a href="/manager/dashboard" class="sidebar-link "><i
                        class="bi bi-speedometer2"></i><span>Dashboard</span></a></li>
            <li><a href="/manager/verify-orders" class="sidebar-link"><i class="bi bi-calendar-check"></i> <span>Verify
                        Order</span></a></li>
            <li><a href="/manager/all-orders" class="sidebar-link active"><i class="bi bi-clipboard-data"></i><span>All
                        Orders</span></a></li>
            <li><a href="/manager/users" class="sidebar-link"><i class="bi bi-people"></i> <span>Users</span></a></li>
            <li><a href="/manager/customers" class="sidebar-link"><i
                        class="bi bi-person-lines-fill"></i><span>Customers</span></a></li>
            <li><a href="/manager/products" class="sidebar-link"><i class="bi bi-box-seam"></i><span>Products</span></a>
            </li>
            <li><a href="/manager/transport" class="sidebar-link"><i class="bi bi-truck"></i><span>Transport</span></a>
            </li>
            <li><a href="/manager/events" class="sidebar-link"><i class="bi-megaphone"></i> <span>Events</span></a></li>
            <li><a href="/logout" class="sidebar-link"><i class="bi bi-box-arrow-right me-2"></i><span>Logout</span></a>
            </li>
        </ul>
        <!-- User Card -->
        <div class="sidebar-user-card" style="color: #4fffb0;">
            <i class="bi bi-person-circle" style="font-size: 1.5em;"></i>
            <span class="user-name" style="color: #ffffff;">{{ session.get('username', 'Manager') }}</span>
        </div>
    </aside>
    <header class="custom-topbar" id="topbar">
        <div class="d-flex w-100 justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 pl-5 mb-1"
            id="topheder">
            <div class="d-flex align-items-center">
                <button class="topbar-menu-btn me-2 pr-5" id="topbarMenuBtn" aria-label="Open menu">
                    <span></span><span></span><span></span>
                </button>
                <h1 class="h2 mb-0">All Orders</h1>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="main-content">

        <div class="main-content-wrapper">
            <!-- Wrapper for the reusable Dashboard component -->
            <div id="invoice-dashboard-container" class="w-full">

                <!-- Search Bar & Filter Container (Combined Input Look) -->
                <div class="mb-8 max-w-3xl mx-auto relative shadow-xl rounded-xl">

                    <!-- Invoice Search Input (Base element, provides space for dropdown with pr-40) -->
                    <input type="text" id="invoiceSearch" placeholder="Search Invoice Number (e.g., EG6TQUSG0E)"
                        class="w-full p-3 pr-40 rounded-xl bg-gray-700 text-light-text border border-gray-600 focus:border-primary-blue focus:ring-1 focus:ring-primary-blue transition duration-200 placeholder-gray-400"
                        onkeyup="filterInvoices()">

                    <!-- Stage Dropdown Filter (Absolutely positioned on the right) -->
                    <select id="stageFilter" onchange="filterInvoices()"
                        class="integrated-select absolute right-0 top-0 h-full w-40 p-3 rounded-r-xl rounded-l-none bg-gray-600 text-light-text border-l border-gray-500 cursor-pointer focus:outline-none focus:ring-1 focus:ring-primary-blue transition duration-200">
                        <option value="All Stages" selected>All Stages</option>
                        <option value="Payment">Payment</option>
                        <option value="Packing">Packing</option>
                        <option value="Transport">Transport</option>
                        <option value="Builty">Builty</option>
                        <option value="Verify Order">Verify Order</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <!-- No Results Message (Hidden by default, shown when no invoices match filters) -->
                <div id="no-results-message"
                    class="hidden mb-8 max-w-3xl mx-auto p-6 rounded-xl bg-red-800/30 border border-red-700 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-400 mx-auto mb-2"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                    <p class="text-xl font-semibold text-red-300">No Invoices Found</p>
                    <!-- Message text customized by JavaScript -->
                    <p class="text-sm text-red-400 mt-1" id="no-results-text">Try adjusting your search query or
                        selecting a different stage filter.</p>
                </div>
                <!-- Dashboard Grid Container -->
                <main class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="dashboardGrid">


                </main>
            </div> <!-- End of #invoice-dashboard-container -->

        </div>

    </main>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="application/json" id="work-data">
    {{ data | tojson }}
    </script>
    <script>

        viewInvoiceDetails = function (invoiceNumber) {
            window.open(`/manager/invoice/${invoiceNumber}`, '_blank', 'noopener');
        };


        function filterInvoices() {
            const input = document.getElementById('invoiceSearch');
            const stageFilter = document.getElementById('stageFilter');
            const noResultsContainer = document.getElementById('no-results-message');
            const noResultsText = document.getElementById('no-results-text');
            const dashboard = document.getElementById("dashboardGrid");

            // Get filter values
            const textFilter = input.value.toUpperCase().trim();
            const selectedStage = stageFilter.value;

            const stageCards = document.querySelectorAll('.stage-card');
            let totalVisibleInvoices = 0;
            const MAX_DISPLAY_COUNT = 3;

            stageCards.forEach(card => {
                const cardStage = card.getAttribute('data-stage');
                const isExpanded = card.getAttribute('data-is-expanded') === 'true';
                const stageCountElement = card.querySelector('.stage-count');
                const loadMoreBtn = card.querySelector('.load-more-btn');

                // 1. Check if the entire stage card should be visible based on the dropdown filter
                const isStageVisibleByFilter = (selectedStage === "All Stages" || selectedStage === cardStage);

                if (!isStageVisibleByFilter) {
                    card.style.display = 'none';
                    if (stageCountElement) { stageCountElement.textContent = '0'; }
                    return;
                }

                card.style.display = 'flex';
                let visibleInvoicesInStage = 0;

                const items = card.querySelectorAll('.invoice-item');
                let filteredItems = [];

                // 2. Perform Text Search Filtering
                items.forEach(item => {
                    const invoiceNumberElement = item.querySelector('p:first-child');
                    let isTextMatch = true;

                    if (invoiceNumberElement) {
                        const invoiceNumber = invoiceNumberElement.textContent.toUpperCase();
                        if (textFilter !== "" && !invoiceNumber.includes(textFilter)) {
                            isTextMatch = false;
                        }
                    }

                    if (isTextMatch) {
                        // Temporarily set display to flex so it's included in filteredItems array
                        item.style.display = 'flex';
                        filteredItems.push(item);
                        visibleInvoicesInStage++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // 3. Apply the 'Show 3 / Load More' truncation logic
                if (visibleInvoicesInStage > MAX_DISPLAY_COUNT) {
                    const hiddenCount = visibleInvoicesInStage - MAX_DISPLAY_COUNT;
                    loadMoreBtn.classList.remove('hidden');

                    if (!isExpanded) {
                        // Truncate: Hide items starting from the 4th (index 3)
                        for (let i = MAX_DISPLAY_COUNT; i < filteredItems.length; i++) {
                            filteredItems[i].style.display = 'none';
                        }
                        loadMoreBtn.textContent = `Show ${hiddenCount} More Invoice${hiddenCount > 1 ? 's' : ''}`;
                    } else {
                        // Expanded: All filtered items are already visible (from step 2)
                        loadMoreBtn.textContent = 'Show Less';
                    }
                } else {
                    // Less than or equal to 3 items, or 0 items
                    loadMoreBtn.classList.add('hidden');
                }

                // 4. Update counts
                totalVisibleInvoices += visibleInvoicesInStage;
                if (stageCountElement) {
                    stageCountElement.textContent = visibleInvoicesInStage.toString();
                }

                // 5. Update No Results Message visibility
                if (totalVisibleInvoices === 0) {
                    let message = "Try adjusting your search query or selecting a different stage filter.";

                    if (textFilter !== "") {
                        message = `No invoice found matching <strong>"${input.value}"</strong> in the current stage view.`;
                    } else if (selectedStage !== "All Stages") {
                        message = `There are currently no invoices in the <strong>${selectedStage}</strong> stage.`;
                    }

                    noResultsText.innerHTML = message;
                    dashboard.classList.add('hidden');
                    noResultsContainer.classList.remove('hidden');
                } else {
                    dashboard.classList.remove('hidden');
                    noResultsContainer.classList.add('hidden');
                }
            });


        }

        function toggleInvoices(stageName) {
            const card = document.querySelector(`.stage-card[data-stage="${stageName}"]`);
            if (!card) return;

            const isExpanded = card.getAttribute('data-is-expanded') === 'true';

            // Toggle the expansion state on the card
            card.setAttribute('data-is-expanded', (!isExpanded).toString());

            // Rerun filterInvoices, which will now use the new data-is-expanded state
            filterInvoices();

            // Optionally scroll to the top of the card when collapsing
            if (isExpanded) {
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function displayData() {

            const data = JSON.parse(
                document.getElementById('work-data').textContent
            );

            const dashboard = document.getElementById("dashboardGrid");

            // Further processing of data can be done here

            if (!data || Object.keys(data).length > 0) {

                dashboard.innerHTML = `
                
                    ${data.Payment && data.Payment.length > 0
                        ?
                        `
                            <!-- Stage Card Component: Payment (2 Invoices - No Load More needed) -->
                            <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-green-500 flex flex-col h-full" data-stage="Payment" data-is-expanded="false">
                                <!-- Stage Title and Count (Combined) -->
                                <h2 class="stage-title text-xl font-bold mb-3 text-green-300 flex justify-between items-center">
                                    <span>Payment</span>
                                    <span class="stage-count text-lg font-extrabold px-2 py-1 bg-green-500/30 text-green-300 rounded-full">${data.Payment.length}</span>
                                </h2>

                                <hr>
                                
                                <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">
                                    <!-- Invoice Items -->
                                    ${data.Payment.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">Date: ${item.stage_date_time}</p>
                                        </div>
                                        
                                        <span
                                            class="text-xs border border-green-400 px-2 py-0.5 rounded-full cursor-pointer
                                                text-green-400 hover:bg-green-400 hover:text-black transition" onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Payment')">
                                    Show More Invoices
                                </button>

                            </div>
                            
                            `

                        : ""
                    }

                    ${data.Packing && data.Packing.length > 0
                        ?
                        `
                            <!-- Stage Card Component: Packing (4 Invoices - Load More needed) -->
                            <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-blue-500 flex flex-col h-full" data-stage="Packing" data-is-expanded="false">
                                <!-- Stage Title and Count (Combined) -->
                                <h2 class="stage-title text-xl font-bold mb-3 text-blue-300 flex justify-between items-center">
                                    <span>Packing</span>
                                    <span class="stage-count text-lg font-extrabold px-2 py-1 bg-blue-500/30 text-blue-300 rounded-full">${data.Packing.length}</span>
                                </h2>
                                <hr>
                                <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">

                                    <!-- Invoice Items -->
                                    ${data.Packing.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">Date: ${item.stage_date_time}</p>
                                        </div>
                                        
                                        <span
                                            class="text-xs border border-green-400 px-2 py-0.5 rounded-full cursor-pointer
                                                text-blue-400 hover:bg-blue-500 hover:text-white transition" onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Packing')">
                                    Show More Invoices
                                </button>

                            </div>
                            
                            `

                        : ""
                    }


                    ${data.Transport && data.Transport.length > 0
                        ?
                        `
                            <!-- Stage Card Component: Transport (1 Invoice - No Load More needed) -->
                            <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-pink-300 flex flex-col h-full" data-stage="Transport" data-is-expanded="false">
                                <!-- Stage Title and Count (Combined) -->
                                <h2 class="stage-title text-xl font-bold mb-3 text-pink-300 flex justify-between items-center">
                                    <span>Transport</span>
                                    <span class="stage-count text-lg font-extrabold px-2 py-1 bg-pink-500/30 text-pink-300 rounded-full">${data.Transport.length}</span>
                                </h2>
                                <hr>
                                <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">

                                    <!-- Invoice Items -->
                                    ${data.Transport.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">Date: ${item.stage_date_time}</p>
                                        </div>
                                        
                                        <span
                                            class="text-xs border border-pink-400 px-2 py-0.5 rounded-full cursor-pointer
                                                text-pink-400 hover:bg-pink-400 hover:text-black transition " onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Transport')">
                                    Show More Invoices
                                </button>

                            </div>
                            
                            `

                        : ""
                    }


                    ${data.Builty && data.Builty.length > 0
                        ?
                        `
                        <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-yellow-500 flex flex-col h-full" data-stage="Builty" data-is-expanded="false">
                            <!-- Stage Title and Count (Combined) -->
                            <h2 class="stage-title text-xl font-bold mb-3 text-yellow-300 flex justify-between items-center">
                                <span>Builty</span>
                                <span class="stage-count text-lg font-extrabold px-2 py-1 bg-yellow-500/30 text-yellow-300 rounded-full">${data.Builty.length}</span>
                            </h2>
                            <hr>
                            <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">
                                    <!-- Invoice Items -->
                                    ${data.Builty.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">Date: ${item.stage_date_time}</p>
                                        </div>
                                        
                                        <span
                                            class="text-xs border border-yellow-400 px-2 py-0.5 rounded-full cursor-pointer
                                                text-yellow-400 hover:bg-yellow-400 hover:text-black transition " onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Builty')">
                                    Show More Invoices
                                </button>

                        </div>
                            
                            `

                        : ""
                    }

                    ${data.Verification && data.Verification.length > 0
                        ?
                        `
                            <!-- Stage Card Component: Verify Order (5 Invoices - Load More needed) -->
                            <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-[#ed9f68] flex flex-col h-full" data-stage="Verify Order" data-is-expanded="false">
                                <!-- Stage Title and Count (Combined) -->
                                <h2 class="stage-title text-xl font-bold mb-3 text-[#ed9f68] flex justify-between items-center">
                                    <span>Verify Order</span>
                                    <span class="stage-count text-lg font-extrabold px-2 py-1 bg-[#ed9f68]/30 text-[#ed9f68] rounded-full ">${data.Verification.length}</span>
                                </h2>
                                <hr>
                                <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">

                                    <!-- Invoice Items -->
                                    ${data.Verification.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">Date: ${item.stage_date_time}</p>
                                        </div>

                                        <span
                                            class="text-xs border border-[#ed9f68] px-2 py-0.5 rounded-full cursor-pointer
                                                text-[#ed9f68] hover:bg-[#ed9f68] hover:text-black transition " onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Verify Order')">
                                    Show More Invoices
                                </button>

                            </div>
                            
                            `

                        : ""
                    }

                    ${data.Completed && data.Completed.length > 0
                        ?
                        `
                            <!-- Stage Card Component: Completed (5 Invoices - Load More needed) -->
                            <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-[#dfed68] flex flex-col h-full" data-stage="Completed" data-is-expanded="false">
                                <!-- Stage Title and Count (Combined) -->
                                <h2 class="stage-title text-xl font-bold mb-3 text-[#dfed68] flex justify-between items-center">
                                    <span>Completed</span>
                                    <span class="stage-count text-lg font-extrabold px-2 py-1 bg-[#dfed68]/30 text-[#dfed68] rounded-full ">${data.Completed.length}</span>
                                </h2>
                                <hr>
                                <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">

                                    <!-- Invoice Items -->
                                    ${data.Completed.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">From: ${item.created_at}</p>
                                            <p class="text-xs text-gray-400">To: ${item.stage_date_time}</p>
                                        </div>

                                        <span
                                            class="text-xs border border-[#dfed68] px-2 py-0.5 rounded-full cursor-pointer
                                                text-[#dfed68] hover:bg-[#dfed68] hover:text-black transition " onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Completed')">
                                    Show More Invoices
                                </button>

                            </div>
                            
                            `

                        : ""
                    }

                    ${data.Cancelled && data.Cancelled.length > 0
                        ?
                        `
                            <!-- Stage Card Component: Cancelled (5 Invoices - Load More needed) -->
                            <div class="stage-card bg-dark-card p-4 rounded-xl shadow-2xl border-t-4 border-red-500 flex flex-col h-full" data-stage="Cancelled" data-is-expanded="false">
                                <!-- Stage Title and Count (Combined) -->
                                <h2 class="stage-title text-xl font-bold mb-3 text-red-400 flex justify-between items-center">
                                    <span>Cancelled</span>
                                    <span class="stage-count text-lg font-extrabold px-2 py-1 bg-red-400/30 text-red-400 rounded-full ">${data.Cancelled.length}</span>
                                </h2>
                                <hr>
                                <!-- List of Invoices for this Stage -->
                                <div class="invoice-list-wrapper space-y-3 flex-grow ">

                                    <!-- Invoice Items -->
                                    ${data.Cancelled.map(item => `
                                    <div class="invoice-item bg-gray-700 p-3 rounded-lg justify-between items-center transition duration-300 hover:bg-gray-600/70">
                                        <div>
                                            <p class="font-semibold text-light-text">${item.invoice_number}</p>
                                            <p class="text-xs text-gray-400">From: ${item.created_at}</p>
                                            <p class="text-xs text-gray-400">At: ${item.stage_date_time}</p>
                                        </div>

                                        <span
                                            class="text-xs border border-red-400 px-2 py-0.5 rounded-full cursor-pointer
                                                text-red-400 hover:bg-red-400 hover:text-black transition " onclick="viewInvoiceDetails('${item.invoice_number}')">
                                            View
                                        </span>

                                    </div>
                                    `).join('')}
                                </div>

                                <!-- Load More Button (Hidden by default, shown if count > 3) -->
                                <button class="load-more-btn mt-3 w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm font-medium rounded-lg text-green-400 border border-gray-600 transition duration-150 hidden" onclick="toggleInvoices('Cancelled')">
                                    Show More Invoices
                                </button>

                            </div>
                            
                            `

                        : ""
                    }


                 
                 
                `;

            } else {
                dashboard.innerHTML = `
                <div class="col-span-1 sm:col-span-2 lg:col-span-3">
                    <div class="bg-dark-card p-6 rounded-xl shadow-2xl border-t-4 border-gray-500 flex flex-col h-full items-center justify-center">
                        <h2 class="text-xl font-bold mb-3 text-gray-400">No Order Data Available</h2>
                        <p class="text-gray-400">There are currently no invoices to display in the workflow.</p>
                    </div>
                </div>
                    `;
            }

        }


        // Sidebar/Topbar toggle logic (no changes to existing JS logic)
        document.addEventListener('DOMContentLoaded', function () {
            var sidebar = document.getElementById('sidebar');
            var sidebarToggle = document.getElementById('sidebarToggle');
            var topbarMenuBtn = document.getElementById('topbarMenuBtn');

            const searchInput = document.getElementById('invoiceSearchInput');
            const trackingStatusFilter = document.getElementById('trackingStatusFilter');

            function openSidebar() {
                document.body.classList.add('sidebar-open');
                sidebar.classList.add('active');
            }
            function closeSidebar() {
                document.body.classList.remove('sidebar-open');
                sidebar.classList.remove('active');
            }
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () {
                    if (sidebar.classList.contains('active')) {
                        closeSidebar();
                    } else {
                        openSidebar();
                    }
                });
            }
            if (topbarMenuBtn) {
                topbarMenuBtn.addEventListener('click', function () {
                    openSidebar();
                });
            }
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function (e) {

                if (!sidebar.contains(e.target) && !topbarMenuBtn.contains(e.target)) {
                    closeSidebar();
                }

            });

            displayData();
            filterInvoices();
        });
    </script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();

        socket.on("force_logout", () => {
            // Optional: call logout endpoint
            window.location.href = "/logout";
        });
    </script>
</body>

</html>