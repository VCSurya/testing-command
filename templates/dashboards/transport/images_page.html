<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invoice Gallery - {{ invoice_id }}</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.ico') }}" type="image/x-icon">
      <script src="{{url_for('static',filename='tailwind.js')}}"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        :root {
            --header-h: 70px;
            --footer-h: 120px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: #e5e7eb;
            overflow: hidden;
            height: 100dvh; /* Use dynamic viewport height for mobile browsers */
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .thumb-active {
            border-color: #3b82f6 !important;
            transform: scale(1.05);
            opacity: 1 !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .image-transition {
            transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Adjustments for very small heights (Landscape Mobile) */
        @media (max-height: 500px) {
            :root {
                --header-h: 50px;
                --footer-h: 80px;
            }
            .hide-on-short { display: none; }
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- Header -->
    <header class="z-50 shrink-0 px-4 md:px-8 flex justify-between items-center glass border-b border-white/5" style="height: var(--header-h);">
        <div class="overflow-hidden">
            <p class="text-[10px] md:text-xs uppercase tracking-widest text-gray-500 font-bold truncate">Packaging Images</p>
            <h1 class="text-lg md:text-xl font-bold text-white tracking-tight truncate">{{ invoice_id }}</h1>
        </div>
        <div class="flex items-center gap-2 md:gap-4 shrink-0">
            <span id="counter" class="text-xs font-mono bg-white/10 px-3 py-1 rounded-full text-gray-300">
                0 / 0
            </span>
            <button onclick="location.reload()" class="p-2 hover:bg-white/10 rounded-full transition-colors text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Viewport -->
    <main id="swipeZone" class="relative flex-1 flex items-center justify-center p-2 md:p-6 overflow-hidden select-none">
        <!-- Ambient Background -->
        <div id="ambient-bg" class="absolute inset-0 opacity-10 blur-[120px] transition-all duration-1000 pointer-events-none"></div>

        <!-- Desktop Navigation Arrows -->
        <button id="prevBtn" class="absolute left-4 z-40 p-4 rounded-full glass hover:bg-white/10 transition-all hidden md:flex items-center justify-center group">
            <svg class="w-6 h-6 text-white group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg>
        </button>

        <!-- Main Image Container -->
        <div id="mainStage" class="relative w-full h-full flex items-center justify-center p-2">
            <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center gap-4 z-10">
                <div class="loader"></div>
            </div>
            
            <img id="activeImage" 
                 src="" 
                 alt="Packaging scan" 
                 class="max-h-full max-w-full object-contain rounded-lg md:rounded-2xl shadow-2xl z-20 opacity-0 image-transition">
        </div>

        <button id="nextBtn" class="absolute right-4 z-40 p-4 rounded-full glass hover:bg-white/10 transition-all hidden md:flex items-center justify-center group">
            <svg class="w-6 h-6 text-white group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"></path></svg>
        </button>
        
        <!-- Mobile Swipe Hint -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 md:hidden text-[10px] text-gray-500 uppercase tracking-widest pointer-events-none opacity-50 animate-pulse">
            Swipe to navigate
        </div>
    </main>

    <!-- Thumbnail Bar -->
    <footer class="glass shrink-0 w-full flex items-center px-4 md:px-8 border-t border-white/5 relative z-50 overflow-hidden" style="height: var(--footer-h);">
        <div id="thumbContainer" class="flex gap-3 md:gap-4 overflow-x-auto no-scrollbar w-full py-4 scroll-smooth">
            <!-- Thumbnails injected here -->
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const invoiceId = "{{ invoice_id }}";
            const activeImage = document.getElementById('activeImage');
            const thumbContainer = document.getElementById('thumbContainer');
            const loading = document.getElementById('loading');
            const counter = document.getElementById('counter');
            const ambientBg = document.getElementById('ambient-bg');
            const swipeZone = document.getElementById('swipeZone');
            
            let images = [];
            let currentIndex = 0;

            // Touch Handling for Swiping
            let touchStartX = 0;
            let touchEndX = 0;

            swipeZone.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            swipeZone.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});

            function handleSwipe() {
                const threshold = 50;
                if (touchEndX < touchStartX - threshold) updateActiveImage(currentIndex + 1);
                if (touchEndX > touchStartX + threshold) updateActiveImage(currentIndex - 1);
            }

            async function fetchImages(id) {
                try {
                    const res = await fetch(`/transport/images/${id}`);
                    const data = await res.json();

                    if (data.success && Array.isArray(data.images) && data.images.length > 0) {
                        images = data.images;
                        initGallery();
                    } else {
                        showError("No images available.");
                    }
                } catch (err) {
                    console.error('Error:', err);
                    showError("Sync Error. Please retry.");
                }
            }

            function initGallery() {
                loading.style.display = 'none';
                thumbContainer.innerHTML = '';
                
                images.forEach((item, index) => {
                    const thumb = document.createElement('div');
                    // Dynamic sizing for thumbnails based on screen height
                    thumb.className = `flex-shrink-0 aspect-square h-full max-h-[80px] md:max-h-[90px] rounded-md md:rounded-lg overflow-hidden cursor-pointer border-2 border-transparent opacity-40 transition-all duration-200 hover:opacity-100`;
                    thumb.innerHTML = `<img src="/transport${item.image_url}" class="w-full h-full object-cover pointer-events-none">`;
                    thumb.onclick = () => updateActiveImage(index);
                    thumbContainer.appendChild(thumb);
                });

                updateActiveImage(0);
            }

            function updateActiveImage(index) {
                if (index < 0 || index >= images.length || images.length === 0) return;
                
                currentIndex = index;
                const item = images[index];

                // Visual transition
                activeImage.style.opacity = '0';
                activeImage.style.transform = 'scale(0.98)';

                setTimeout(() => {
                    activeImage.src = '/transport'+item.image_url;
                    activeImage.onload = () => {
                        activeImage.style.opacity = '1';
                        activeImage.style.transform = 'scale(1)';
                        ambientBg.style.backgroundColor = (index % 2 === 0) ? '#1e40af' : '#1e3a8a'; 
                    };

                    counter.innerText = `${currentIndex + 1} / ${images.length}`;
                    
                    // Update Thumbnails
                    Array.from(thumbContainer.children).forEach((t, i) => {
                        if (i === currentIndex) {
                            t.classList.add('thumb-active');
                            t.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        } else {
                            t.classList.remove('thumb-active');
                        }
                    });
                }, 100);
            }

            function showError(msg) {
                loading.innerHTML = `<p class="text-gray-500 text-xs font-mono tracking-tighter uppercase px-6 py-2 border border-white/10 rounded">${msg}</p>`;
            }

            // Keyboard
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') updateActiveImage(currentIndex - 1);
                if (e.key === 'ArrowRight') updateActiveImage(currentIndex + 1);
            });

            // Buttons
            document.getElementById('prevBtn').onclick = () => updateActiveImage(currentIndex - 1);
            document.getElementById('nextBtn').onclick = () => updateActiveImage(currentIndex + 1);

            fetchImages(invoiceId);
        });
    </script>
</body>
</html>