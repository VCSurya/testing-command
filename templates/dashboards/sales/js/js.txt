    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
                
                // Toggle overlay when sidebar is shown on mobile
                if (window.innerWidth < 992) {
                    if (sidebar.classList.contains('collapsed')) {
                        overlay.classList.remove('active');
                    } else {
                        overlay.classList.add('active');
                    }
                }
            }

            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Close sidebar when clicking on overlay
            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                if (!document.getElementById('sidebar').classList.contains('collapsed')) {
                    toggleSidebar();
                }
            });
            
            // Initialize sidebar state based on screen size
            function initSidebar() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                if (window.innerWidth < 992) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('expanded');
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('expanded');
                }
            }
            
            // Initialize sidebar on page load
            initSidebar();
            
            // Update sidebar state on window resize
            window.addEventListener('resize', initSidebar);

            if (overlay) {
                overlay.addEventListener('click', toggleSidebar);
            }

            window.addEventListener('resize', function () {
                if (window.innerWidth > 992 && sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                }
            });

            // Billing System JavaScript
            let customers = [];
            let products = [];
            let selectedProducts = [];
            let grandTotal = 0;
            const GST_RATE = 18; // 18% GST
            let currentProduct = null;

            // Initialize Select2 for customer select
            $(document).ready(function () {
                $('#customerSelect').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Search and select customer',
                    allowClear: true,
                    width: '87.5%'
                });

                // Initialize product select with search enabled
                $('#modalProductSelect').select2({
                    theme: 'bootstrap-5',
                    placeholder: 'Search and select product',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#productDetailsModal'),
                    minimumInputLength: 0,
                    language: {
                        noResults: function () {
                            return "No products found";
                        }
                    }
                });

                // Add event listener for product selection
                $('#modalProductSelect').on('select2:select', function (e) {
                    const productId = e.params.data.id;
                    currentProduct = products.find(p => p.id == productId);
                    if (currentProduct) {
                        document.getElementById('modalBasePrice').value = currentProduct.price;
                        document.getElementById('modalQuantity').value = 1;
                        // document.getElementById('modalIncludeGST').checked = true;
                        updateModalFinalPrice();
                    }
                });

                // Add event listener for product deselection
                $('#modalProductSelect').on('select2:clear', function () {
                    document.getElementById('modalBasePrice').value = '';
                    document.getElementById('modalQuantity').value = 1;
                    document.getElementById('modalFinalPrice').value = '';
                });
            });

            // Load customers and products from the server
            fetchCustomers();
            fetchProducts();

            // Set up event listeners
            document.getElementById('addProductBtn').addEventListener('click', showProductDetailsModal);
            document.getElementById('addCustomerBtn').addEventListener('click', addCustomerModal);
            document.getElementById('addPaymentButton').addEventListener('click', showOtherPaymentDetailsTextBox);

            document.getElementById('confirmAddCustomer').addEventListener('click', addCustomer);
            document.getElementById('confirmAddProduct').addEventListener('click', addProduct);
            document.getElementById('billingForm').addEventListener('submit', handleSubmit);
            document.getElementById('printBtn').addEventListener('click', printBill);

            // Modal event listeners
            document.getElementById('modalBasePrice').addEventListener('input', updateModalFinalPrice);
            document.getElementById('modalQuantity').addEventListener('input', updateModalFinalPrice);

            // document.getElementById('modalIncludeGST').addEventListener('change', updateModalFinalPrice);

            // Delivery mode select change handler
            document.getElementById('deliveryMode').addEventListener('change', function () {
                const transportCompanyGroup = document.getElementById('transportCompanyGroup');
                if (this.value === 'transport') {
                    transportCompanyGroup.style.display = 'block';

                } else {
                    transportCompanyGroup.style.display = 'none';
                    document.getElementById('transportCompany').value = '';
                }
            });

            // Payment mode select change handler
            document.getElementById('paymentMode').addEventListener('change', function () {
                const paymentTypeGroup = document.getElementById('paymentTypeGroup');
                const paidAmountGroup = document.getElementById('paidAmountGroup');
                const leftToPayGroup = document.getElementById('leftToPayGroup');

                if (this.value === 'not_paid') {
                    paymentTypeGroup.style.display = 'none';
                    paidAmountGroup.style.display = 'none';
                    leftToPayGroup.style.display = 'none';
                } else {
                    paymentTypeGroup.style.display = 'block';
                    leftToPayGroup.style.display = 'none';
                }
            });

            // Payment type select change handler
            document.getElementById('paymentType').addEventListener('change', function () {
                const paidAmountGroup = document.getElementById('paidAmountGroup');
                const paidAmountField = document.getElementById('paidAmount');
                const leftToPayGroup = document.getElementById('leftToPayGroup');

                if (this.value === 'full_payment') {
                    paidAmountGroup.style.display = 'none';
                    leftToPayGroup.style.display = 'none';
                    paidAmountField.value = grandTotal.toFixed(2);
                    paidAmountField.required = false;
                } else if (this.value === 'half_payment') {
                    paidAmountGroup.style.display = 'block';
                    leftToPayGroup.style.display = 'block';
                    paidAmountField.value = (grandTotal / 2).toFixed(2);
                    paidAmountField.required = true;
                }
                updateLeftToPay();
            });

            // Update totals
            function updateTotals() {
                grandTotal = selectedProducts.reduce((sum, product) => sum + product.total, 0);
                document.getElementById('grandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
                document.getElementById('grandTotalInput').value = grandTotal;


                // Update paid amount max value
                const paidAmountField = document.getElementById('paidAmount');

                if (paidAmountField) {
                    paidAmountField.max = grandTotal;
                    const currentValue = parseFloat(paidAmountField.value) || 0;
                    if (currentValue > grandTotal) {
                        paidAmountField.value = grandTotal.toFixed(2);
                    }
                }

                // Update left to pay amount
                updateLeftToPay();
            }

            // Validate paid amount
            window.validatePaidAmount = function (input) {
                const value = parseFloat(input.value) || 0;
                const max = parseFloat(input.max) || 0;

                if (value < 0) {
                    input.value = '0';
                } else if (value > max) {
                    input.value = max.toFixed(2);
                }

                updateLeftToPay();
            };

            // Update left to pay amount
            function updateLeftToPay() {
                const paymentType = document.getElementById('paymentType').value;
                let paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;;
                let leftToPay = 0;


                if (paymentType === 'full_payment') {
                    document.getElementById('paidAmount').value = grandTotal;
                    paidAmount = grandTotal;
                } else {
                    paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
                }

                leftToPay = Math.max(grandTotal - paidAmount, 0);
                document.getElementById('leftToPayDisplay').value = `₹${leftToPay.toFixed(2)}`;
                document.getElementById('leftToPayInput').value = leftToPay.toFixed(2);


                if (paidAmount < grandTotal) {
                    document.getElementById('paymentType').value = 'half_payment';
                } else {
                    document.getElementById('paymentType').value = 'full_payment';
                }

                if (paidAmount == 0) {
                    document.getElementById('leftToPayDisplay').value = `₹${grandTotal.toFixed(2)}`;
                }


            }

            // Fetch customers from the server
            function fetchCustomers() {
                fetch('/sales/customers')
                    .then(response => response.json())
                    .then(data => {
                        customers = data;
                        const customerSelect = document.getElementById('customerSelect');
                        customerSelect.innerHTML = '<option value="">Select Customer</option>';
                        data.forEach(customer => {
                            const option = document.createElement('option');
                            option.value = customer.id;
                            option.textContent = `${customer.name}`;
                            customerSelect.appendChild(option);
                        });
                        $('#customerSelect').trigger('change');
                    })
                    .catch(error => {
                        console.error('Error fetching customers:', error);
                        alert('Failed to load customers. Please refresh the page and try again.');
                    });
            }

            // Fetch products from the server
            function fetchProducts() {
                fetch('/sales/products')
                    .then(response => response.json())
                    .then(data => {
                        products = data;
                        const productSelect = $('#modalProductSelect');
                        productSelect.empty();
                        productSelect.append('<option value="">Search and select product</option>');

                        data.forEach(product => {
                            const option = new Option(
                                `${product.name}`,
                                product.id,
                                false,
                                false
                            );
                            productSelect.append(option);
                        });

                        // Refresh Select2
                        productSelect.trigger('change');
                    })
                    .catch(error => {
                        console.error('Error fetching products:', error);
                        alert('Failed to load products. Please refresh the page and try again.');
                    });
            }

            // Show product details modal
            function addCustomerModal() {

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('customerModal'));
                modal.show();

            }

            function showOtherPaymentDetailsTextBox() {

                const otherPaymentDetails = document.getElementById('otherPaymentDetails');

                if (otherPaymentDetails.style.display === 'none' || otherPaymentDetails.style.display === '') {
                    otherPaymentDetails.style.display = 'block'; // Show the element
                } else {
                    otherPaymentDetails.style.display = 'none';  // Hide the element
                    document.getElementById('otherPaymentNote').value = ''; // Clear input value
                }


            }

            // Show product details modal
            function showProductDetailsModal() {
                // Reset modal form
                $('#modalProductSelect').val('').trigger('change');
                document.getElementById('modalBasePrice').value = '';
                document.getElementById('modalQuantity').value = 1;
                // document.getElementById('modalIncludeGST').checked = true;
                document.getElementById('modalFinalPrice').value = '';

                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
                modal.show();

                // Focus on the product select and open dropdown
                setTimeout(() => {
                    $('#modalProductSelect').select2('open');
                }, 500);
            }

            // Update modal final price
            function updateModalFinalPrice() {
                const basePrice = parseFloat(document.getElementById('modalBasePrice').value) || 0;
                const quantity = parseInt(document.getElementById('modalQuantity').value) || 1;
                // const includeGST = document.getElementById('modalIncludeGST').checked;

                document.getElementById('modalFinalPrice').value = (basePrice * quantity).toFixed(2);
            }

            // Add new customer
            function addCustomer() {
                const customerName = document.getElementById('customerName').value;
                const customerAddress = document.getElementById('customerAddress').value;
                const customerState = document.getElementById('customerState').value;
                const customerPincode = document.getElementById('customerPincode').value;
                const customerMobile = document.getElementById('customerMobile').value;

                if (!customerName || !customerAddress || !customerPincode || !customerMobile) {
                    alert('Please fill in all fields.');
                    return;
                }

                // Send data to server
                fetch('/sales/add-customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: customerName,
                        address: customerAddress,
                        state: customerState,
                        pincode: customerPincode,
                        mobile: customerMobile
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Customer added successfully.');
                            $('#customerModal').modal('hide');

                            // Clear the form fields
                            document.getElementById('customerName').value = '';
                            document.getElementById('customerAddress').value = '';
                            document.getElementById('customerState').value = '';
                            document.getElementById('customerPincode').value = '';
                            document.getElementById('customerMobile').value = '';
                            fetchCustomers();

                        } else {
                            alert('Failed to add customer. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error adding customer:', error);
                        alert('Failed to add customer. Please try again.');
                    });
            }

            // Add product to the bill
            function addProduct() {
                if (!currentProduct) {
                    alert('Please select a product first.');
                    return;
                }

                const basePrice = parseFloat(document.getElementById('modalBasePrice').value);
                const quantity = parseInt(document.getElementById('modalQuantity').value);
                // const includeGST = document.getElementById('modalIncludeGST').checked;

                if (isNaN(basePrice) || basePrice <= 0) {
                    alert('Please enter a valid price.');
                    return;
                }

                if (isNaN(quantity) || quantity <= 0) {
                    alert('Please enter a valid quantity.');
                    return;
                }

                // let gstAmount = 0;
                // let finalPrice = basePrice;
                // let calculatedBasePrice = basePrice;

                const productTotal = basePrice * quantity;

                // Check if product already exists in the table
                const existingProductIndex = selectedProducts.findIndex(p => p.id == currentProduct.id);
                if (existingProductIndex !== -1) {
                    // Update the existing product
                    selectedProducts[existingProductIndex].quantity += quantity;
                    selectedProducts[existingProductIndex].total += productTotal;
                } else {
                    // Add new product
                    selectedProducts.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        // basePrice: calculatedBasePrice,
                        // gstAmount: gstAmount,
                        finalPrice: basePrice,
                        quantity: quantity,
                        total: productTotal,
                        // includeGST: includeGST
                    });
                }

                updateProductTable();
                updateTotals();

                // Reset modal form
                $('#modalProductSelect').val('').trigger('change');
                document.getElementById('modalBasePrice').value = '';
                document.getElementById('modalQuantity').value = 1;
                // document.getElementById('modalIncludeGST').checked = true;
                document.getElementById('modalFinalPrice').value = '';

                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailsModal'));
                modal.hide();
            }

            // Update product table
            function updateProductTable() {
                const tableBody = document.getElementById('productTableBody');
                tableBody.innerHTML = '';

                selectedProducts.forEach((product, index) => {
                    const row = document.createElement('tr');
                    row.className = 'product-row';
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>₹${product.finalPrice.toFixed(2)}</td>
                        <td>${product.quantity}</td>
                        <td>₹${product.total.toFixed(2)}</td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeProduct(${index})">Remove</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Update paid amount max value when grand total changes
                const paidAmountField = document.getElementById('paidAmount');
                if (paidAmountField) {
                    paidAmountField.max = grandTotal;
                    const currentValue = parseFloat(paidAmountField.value) || 0;
                    if (currentValue < 0) {
                        paidAmountField.value = '0';
                    } else if (currentValue > grandTotal) {
                        paidAmountField.value = grandTotal.toFixed(2);
                    }
                    updateLeftToPay();
                }
            }

            // Remove product from the bill
            window.removeProduct = function (index) {
                selectedProducts.splice(index, 1);
                updateProductTable();
                updateTotals();
            };

            // Handle form submission
            function handleSubmit(event) {
                event.preventDefault();

                if (selectedProducts.length === 0) {
                    alert('Please add at least one product to the bill.');
                    return;
                }

                // Show loading spinner
                document.getElementById('loadingOverlay').style.display = 'flex';

                // Prepare form data
                const formData = new FormData(event.target);

                // Add product data
                formData.append('products', JSON.stringify(selectedProducts));

                // Send data to server
                fetch('/sales/generate', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || 'Failed to generate bill');
                            });
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // Hide loading spinner
                        document.getElementById('loadingOverlay').style.display = 'none';

                        // Create URL for the PDF blob
                        const pdfUrl = URL.createObjectURL(blob);

                        // Open PDF in new tab
                        window.open(pdfUrl, '_blank');
                    })
                    .catch(error => {
                        // Hide loading spinner
                        document.getElementById('loadingOverlay').style.display = 'none';
                        console.error('Error:', error);
                        alert(`Failed to generate bill: ${error.message}`);
                    });
            }

            // Print bill
            // function printBill() {
            //     if (selectedProducts.length === 0) {
            //         alert('Please add at least one product to the bill.');
            //         return;
            //     }

            //     // Prepare form data
            //     const formData = new FormData(document.getElementById('billingForm'));
            //     formData.append('products', JSON.stringify(selectedProducts));

            //     // Send data to server to generate PDF
            //     fetch('/sales/generate', {
            //         method: 'POST',
            //         body: formData
            //     })
            //         .then(response => {
            //             if (!response.ok) {
            //                 throw new Error('Failed to generate bill');
            //             }
            //             return response.blob();
            //         })
            //         .then(blob => {
            //             const pdfUrl = URL.createObjectURL(blob);
            //             const printWindow = window.open(pdfUrl);
            //             printWindow.onload = function () {
            //                 printWindow.print();
            //             };
            //         })
            //         .catch(error => {
            //             console.error('Error:', error);
            //             alert('Failed to print bill. Please try again.');
            //         });
            // }

            function printBill() {
                if (selectedProducts.length === 0) {
                    alert('Please add at least one product to the bill.');
                    return;
                }

                // Prepare form data
                const formData = new FormData(document.getElementById('billingForm'));
                formData.append('products', JSON.stringify(selectedProducts));

                // Send data to server to generate PDF
                fetch('/sales/generate', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to generate bill');
                        }
                        return response.blob(); // PDF blob
                    })
                    .then(blob => {
                        // // Create object URL for PDF
                        // const pdfUrl = URL.createObjectURL(blob);

                        // // Open print preview window
                        // const printWindow = window.open(pdfUrl);
                        // printWindow.onload = function () {
                        //     printWindow.print();
                        // };

                        // Attempt native sharing if supported
                        const pdfFile = new File([blob], 'bill.pdf', { type: 'application/pdf' });

                        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                            navigator.share({
                                title: 'Bill PDF',
                                text: 'Here is your bill.',
                                files: [pdfFile]
                            }).then(() => {
                                console.log('Share successful');
                            }).catch(error => {
                                console.warn('Share failed or cancelled:', error);
                            });
                        } else {
                            console.log('Native sharing not supported on this device/browser.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to print bill. Please try again.');
                    });
            }


        });

        // Clear form function
        function clearForm() {
            document.getElementById('billingForm').reset();
            document.getElementById('productTableBody').innerHTML = '';
            // Reset all form inputs
            $('form')[0].reset();

            // Reset Select2 dropdown and show placeholder
            $('#customerSelect').val(null).trigger('change');

            selectedProducts = [];
            grandTotal = 0;
            updateTotals();
        }
        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        // Show loading spinner on form submission
        document.getElementById('billingForm').addEventListener('submit', showLoading);
        // Hide loading spinner on form reset
        document.getElementById('billingForm').addEventListener('reset', hideLoading);
        // Hide loading spinner on page load
        window.addEventListener('load', hideLoading);


    </script>